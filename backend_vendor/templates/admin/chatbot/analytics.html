{% extends 'admin/base.html' %}
{% load static %}

{% block title %}Chat Analytics - OVN Store Admin{% endblock %}

{% block extra_css %}
<style>
    .analytics-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .period-selector {
        display: flex;
        gap: 0.5rem;
    }

    .period-btn {
        padding: 0.5rem 1rem;
        border: 1px solid #e2e8f0;
        background: white;
        border-radius: 8px;
        color: #64748b;
        cursor: pointer;
        font-size: 0.875rem;
        text-decoration: none;
    }

    .period-btn:hover,
    .period-btn.active {
        background: #6366f1;
        color: white;
        border-color: #6366f1;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .stat-card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1rem;
    }

    .stat-card-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
    }

    .stat-card-icon.blue { background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; }
    .stat-card-icon.green { background: linear-gradient(135deg, #10b981, #34d399); color: white; }
    .stat-card-icon.orange { background: linear-gradient(135deg, #f59e0b, #fbbf24); color: white; }
    .stat-card-icon.purple { background: linear-gradient(135deg, #8b5cf6, #a78bfa); color: white; }

    .stat-card h3 {
        font-size: 2rem;
        font-weight: 700;
        margin: 0;
        color: #1e293b;
    }

    .stat-card p {
        margin: 0.25rem 0 0 0;
        color: #64748b;
        font-size: 0.875rem;
    }

    .charts-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    @media (max-width: 1200px) {
        .charts-grid {
            grid-template-columns: 1fr;
        }
    }

    .chart-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .chart-card h3 {
        margin: 0 0 1rem 0;
        font-size: 1rem;
        color: #475569;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .chart-container {
        height: 300px;
        position: relative;
    }

    .recent-messages {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .recent-messages h3 {
        margin: 0 0 1rem 0;
        font-size: 1rem;
        color: #475569;
    }

    .message-list {
        max-height: 400px;
        overflow-y: auto;
    }

    .message-item {
        display: flex;
        gap: 1rem;
        padding: 0.875rem;
        border-bottom: 1px solid #f1f5f9;
    }

    .message-item:last-child {
        border-bottom: none;
    }

    .message-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .message-avatar.user {
        background: #6366f1;
        color: white;
    }

    .message-avatar.bot {
        background: #10b981;
        color: white;
    }

    .message-content {
        flex: 1;
        min-width: 0;
    }

    .message-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.25rem;
    }

    .message-name {
        font-weight: 600;
        font-size: 0.875rem;
        color: #1e293b;
    }

    .message-time {
        font-size: 0.75rem;
        color: #94a3b8;
    }

    .message-text {
        font-size: 0.875rem;
        color: #64748b;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .intent-list {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .intent-item {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .intent-name {
        flex: 1;
        font-size: 0.875rem;
        color: #475569;
        text-transform: capitalize;
    }

    .intent-bar {
        flex: 2;
        height: 8px;
        background: #f1f5f9;
        border-radius: 4px;
        overflow: hidden;
    }

    .intent-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #6366f1, #8b5cf6);
        border-radius: 4px;
    }

    .intent-count {
        font-size: 0.875rem;
        font-weight: 600;
        color: #1e293b;
        width: 40px;
        text-align: right;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-title">
        <h1><i class="fas fa-chart-area"></i> Chat Analytics</h1>
        <p>Insights and statistics from chatbot conversations</p>
    </div>
</div>

<!-- Analytics Header -->
<div class="analytics-header">
    <div class="period-selector">
        <a href="?days=7" class="period-btn {% if days == 7 %}active{% endif %}">7 Days</a>
        <a href="?days=14" class="period-btn {% if days == 14 %}active{% endif %}">14 Days</a>
        <a href="?days=30" class="period-btn {% if days == 30 %}active{% endif %}">30 Days</a>
    </div>
    <a href="{% url 'chatbot:sessions' %}" class="period-btn">
        <i class="fas fa-comments"></i> View Chat Logs
    </a>
</div>

<!-- Stats Cards -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-card-header">
            <div>
                <h3>{{ summary.total_sessions }}</h3>
                <p>Total Sessions</p>
            </div>
            <div class="stat-card-icon blue">
                <i class="fas fa-comments"></i>
            </div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-card-header">
            <div>
                <h3>{{ summary.active_sessions }}</h3>
                <p>Active Now</p>
            </div>
            <div class="stat-card-icon green">
                <i class="fas fa-circle-dot"></i>
            </div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-card-header">
            <div>
                <h3>{{ conversion.orders_placed }}</h3>
                <p>Orders Placed</p>
            </div>
            <div class="stat-card-icon orange">
                <i class="fas fa-shopping-cart"></i>
            </div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-card-header">
            <div>
                <h3>{{ conversion.conversion_rate }}%</h3>
                <p>Conversion Rate</p>
            </div>
            <div class="stat-card-icon purple">
                <i class="fas fa-percentage"></i>
            </div>
        </div>
    </div>
</div>

<!-- Charts -->
<div class="charts-grid">
    <!-- Daily Activity Chart -->
    <div class="chart-card">
        <h3><i class="fas fa-chart-line"></i> Daily Activity</h3>
        <div class="chart-container">
            <canvas id="dailyChart"></canvas>
        </div>
    </div>

    <!-- Peak Hours Chart -->
    <div class="chart-card">
        <h3><i class="fas fa-clock"></i> Peak Hours</h3>
        <div class="chart-container">
            <canvas id="hoursChart"></canvas>
        </div>
    </div>

    <!-- Top Intents -->
    <div class="chart-card">
        <h3><i class="fas fa-brain"></i> Top Intents</h3>
        <div class="intent-list" id="intentsList">
            <!-- Populated by JS -->
        </div>
    </div>

    <!-- Recent Messages -->
    <div class="chart-card">
        <h3><i class="fas fa-message"></i> Recent Messages</h3>
        <div class="message-list">
            {% for msg in recent_messages %}
            <div class="message-item">
                <div class="message-avatar {% if msg.role == 'user' %}user{% else %}bot{% endif %}">
                    {% if msg.role == 'user' %}
                    <i class="fas fa-user"></i>
                    {% else %}
                    <i class="fas fa-robot"></i>
                    {% endif %}
                </div>
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-name">{{ msg.user_name|default:"Customer" }}</span>
                        <span class="message-time">{{ msg.timestamp }}</span>
                    </div>
                    <div class="message-text">{{ msg.content|truncatechars:80 }}</div>
                </div>
            </div>
            {% empty %}
            <div style="text-align: center; padding: 2rem; color: #94a3b8;">
                <i class="fas fa-message" style="font-size: 2rem; margin-bottom: 0.5rem; display: block;"></i>
                <p>No recent messages</p>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<script>
    // Data from Django
    const dailyStats = {{ daily_stats|safe }};
    const peakHours = {{ peak_hours|safe }};
    const topIntents = {{ top_intents|safe }};

    // Daily Activity Chart
    const dailyCtx = document.getElementById('dailyChart').getContext('2d');
    new Chart(dailyCtx, {
        type: 'line',
        data: {
            labels: dailyStats.map(d => d.date),
            datasets: [{
                label: 'Sessions',
                data: dailyStats.map(d => d.sessions),
                borderColor: '#6366f1',
                backgroundColor: 'rgba(99, 102, 241, 0.1)',
                fill: true,
                tension: 0.4
            }, {
                label: 'Messages',
                data: dailyStats.map(d => d.messages),
                borderColor: '#10b981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top'
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Peak Hours Chart
    const hoursCtx = document.getElementById('hoursChart').getContext('2d');
    new Chart(hoursCtx, {
        type: 'bar',
        data: {
            labels: peakHours.map(h => h.hour + ':00'),
            datasets: [{
                label: 'Activity',
                data: peakHours.map(h => h.count),
                backgroundColor: 'rgba(99, 102, 241, 0.8)',
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Top Intents List
    const intentsList = document.getElementById('intentsList');
    const maxCount = topIntents.length > 0 ? Math.max(...topIntents.map(i => i.count)) : 1;

    topIntents.forEach(intent => {
        const percentage = (intent.count / maxCount) * 100;
        intentsList.innerHTML += `
            <div class="intent-item">
                <span class="intent-name">${intent.intent.replace(/_/g, ' ')}</span>
                <div class="intent-bar">
                    <div class="intent-bar-fill" style="width: ${percentage}%"></div>
                </div>
                <span class="intent-count">${intent.count}</span>
            </div>
        `;
    });

    if (topIntents.length === 0) {
        intentsList.innerHTML = '<div style="text-align: center; padding: 2rem; color: #94a3b8;">No intent data available</div>';
    }
</script>
{% endblock %}
