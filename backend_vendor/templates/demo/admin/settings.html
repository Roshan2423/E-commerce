{% extends 'admin/base.html' %}
{% load static %}

{% block title %}Demo Settings - Admin{% endblock %}

{% block extra_css %}
<style>
    .demo-settings-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
    }

    .demo-settings-header h1 {
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--text-primary);
    }

    .demo-settings-header .header-actions {
        display: flex;
        gap: 0.75rem;
    }

    .stats-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 1.25rem;
        text-align: center;
    }

    .stat-card .stat-value {
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--primary-color);
    }

    .stat-card .stat-label {
        font-size: 0.875rem;
        color: var(--text-secondary);
        margin-top: 0.25rem;
    }

    .section-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        margin-bottom: 1.5rem;
        overflow: hidden;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 1.5rem;
        background: var(--hover-bg);
        border-bottom: 1px solid var(--border-color);
        cursor: pointer;
    }

    .section-header h3 {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .section-header .count-badge {
        background: var(--primary-color);
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .section-header .toggle-icon {
        transition: transform 0.3s ease;
    }

    .section-header.collapsed .toggle-icon {
        transform: rotate(-90deg);
    }

    .section-body {
        padding: 1.5rem;
        max-height: 500px;
        overflow-y: auto;
    }

    .section-body.collapsed {
        display: none;
    }

    .products-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 1rem;
    }

    .product-select-card {
        background: var(--hover-bg);
        border: 2px solid var(--border-color);
        border-radius: 10px;
        padding: 1rem;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
    }

    .product-select-card:hover {
        border-color: var(--primary-color);
        transform: translateY(-2px);
    }

    .product-select-card.selected {
        border-color: var(--primary-color);
        background: rgba(99, 102, 241, 0.1);
    }

    .product-select-card .checkbox-wrapper {
        position: absolute;
        top: 0.75rem;
        right: 0.75rem;
    }

    .product-select-card input[type="checkbox"] {
        width: 20px;
        height: 20px;
        accent-color: var(--primary-color);
        cursor: pointer;
    }

    .product-select-card .product-image {
        width: 100%;
        height: 120px;
        background: var(--card-bg);
        border-radius: 8px;
        overflow: hidden;
        margin-bottom: 0.75rem;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .product-select-card .product-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .product-select-card .product-image .no-image {
        color: var(--text-secondary);
        font-size: 2rem;
    }

    .product-select-card .product-name {
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 0.25rem;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .product-select-card .product-price {
        font-size: 0.875rem;
        color: var(--primary-color);
        font-weight: 600;
    }

    .product-select-card .product-vendor {
        font-size: 0.75rem;
        color: var(--text-secondary);
        margin-top: 0.25rem;
    }

    .categories-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 0.75rem;
    }

    .category-select-card {
        background: var(--hover-bg);
        border: 2px solid var(--border-color);
        border-radius: 8px;
        padding: 0.75rem 1rem;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .category-select-card:hover {
        border-color: var(--primary-color);
    }

    .category-select-card.selected {
        border-color: var(--primary-color);
        background: rgba(99, 102, 241, 0.1);
    }

    .category-select-card input[type="checkbox"] {
        width: 18px;
        height: 18px;
        accent-color: var(--primary-color);
    }

    .category-select-card .category-name {
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--text-primary);
    }

    .search-bar {
        display: flex;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .search-bar input {
        flex: 1;
        padding: 0.75rem 1rem;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        background: var(--card-bg);
        color: var(--text-primary);
        font-size: 0.875rem;
    }

    .search-bar input:focus {
        outline: none;
        border-color: var(--primary-color);
    }

    .btn-primary {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
    }

    .btn-secondary {
        background: var(--hover-bg);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .btn-secondary:hover {
        background: var(--border-color);
    }

    .btn-danger {
        background: #ef4444;
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .btn-danger:hover {
        background: #dc2626;
    }

    .section-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid var(--border-color);
    }

    .select-all-btn {
        font-size: 0.8rem;
        padding: 0.5rem 1rem;
        background: var(--hover-bg);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        cursor: pointer;
        color: var(--text-secondary);
    }

    .select-all-btn:hover {
        background: var(--border-color);
        color: var(--text-primary);
    }

    .empty-state {
        text-align: center;
        padding: 2rem;
        color: var(--text-secondary);
    }

    .empty-state i {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    .preview-link {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--primary-color);
        text-decoration: none;
        font-weight: 500;
    }

    .preview-link:hover {
        text-decoration: underline;
    }
</style>
{% endblock %}

{% block content %}
<form method="post" id="demoSettingsForm">
    {% csrf_token %}
    <input type="hidden" name="action" value="save_settings">

    <div class="demo-settings-header">
        <div>
            <h1><i class="fas fa-palette"></i> Demo Page Settings</h1>
            <p style="color: var(--text-secondary); margin-top: 0.25rem;">
                Select which products appear in the demo storefront pages.
                <a href="{% url 'demo:pro_user_home' %}" target="_blank" class="preview-link">
                    <i class="fas fa-external-link-alt"></i> Preview Demo
                </a>
            </p>
        </div>
        <div class="header-actions">
            <button type="button" class="btn-danger" onclick="clearAllSelections()">
                <i class="fas fa-trash-alt"></i> Clear All
            </button>
            <button type="submit" class="btn-primary">
                <i class="fas fa-save"></i> Save Settings
            </button>
        </div>
    </div>

    <!-- Stats Row -->
    <div class="stats-row">
        <div class="stat-card">
            <div class="stat-value">{{ total_products }}</div>
            <div class="stat-label">Available Products</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="featuredCount">{{ featured_count }}</div>
            <div class="stat-label">Featured Selected</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="flashSaleCount">{{ flash_sale_count }}</div>
            <div class="stat-label">Flash Sale Selected</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="newArrivalsCount">{{ new_arrivals_count }}</div>
            <div class="stat-label">New Arrivals Selected</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="allCount">{{ all_count }}</div>
            <div class="stat-label">All Products Selected</div>
        </div>
    </div>

    <!-- Search Bar -->
    <div class="search-bar">
        <input type="text" id="productSearch" placeholder="Search products by name or SKU..." value="{{ search }}">
        <button type="button" class="btn-secondary" onclick="filterProducts()">
            <i class="fas fa-search"></i> Search
        </button>
    </div>

    <!-- Categories Section -->
    <div class="section-card">
        <div class="section-header" onclick="toggleSection(this)">
            <h3>
                <i class="fas fa-folder-tree"></i>
                Categories
                <span class="count-badge" id="categoriesBadge">{{ categories_count }}</span>
            </h3>
            <i class="fas fa-chevron-down toggle-icon"></i>
        </div>
        <div class="section-body">
            {% if all_categories %}
            <div class="categories-grid">
                {% for category in all_categories %}
                <label class="category-select-card {% if category.id in selected_categories %}selected{% endif %}">
                    <input type="checkbox" name="categories" value="{{ category.id }}"
                           {% if category.id in selected_categories %}checked{% endif %}
                           onchange="updateCategoryCard(this)">
                    <span class="category-name">{{ category.name }}</span>
                </label>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">
                <i class="fas fa-folder-open"></i>
                <p>No categories available</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Featured Products Section -->
    <div class="section-card">
        <div class="section-header" onclick="toggleSection(this)">
            <h3>
                <i class="fas fa-star"></i>
                Featured Products
                <span class="count-badge" id="featuredBadge">{{ featured_count }}</span>
            </h3>
            <i class="fas fa-chevron-down toggle-icon"></i>
        </div>
        <div class="section-body">
            {% if all_products %}
            <div class="products-grid">
                {% for product in all_products %}
                <label class="product-select-card {% if product.id in selected_featured %}selected{% endif %}" data-name="{{ product.name|lower }}" data-sku="{{ product.sku|lower }}">
                    <div class="checkbox-wrapper">
                        <input type="checkbox" name="featured_products" value="{{ product.id }}"
                               {% if product.id in selected_featured %}checked{% endif %}
                               onchange="updateProductCard(this, 'featured')">
                    </div>
                    <div class="product-image">
                        {% if product.get_main_image %}
                        <img src="{{ product.get_main_image }}" alt="{{ product.name }}">
                        {% else %}
                        <i class="fas fa-image no-image"></i>
                        {% endif %}
                    </div>
                    <div class="product-name" title="{{ product.name }}">{{ product.name }}</div>
                    <div class="product-price">Rs. {{ product.price }}</div>
                    {% if product.vendor %}
                    <div class="product-vendor">{{ product.vendor.business_name }}</div>
                    {% endif %}
                </label>
                {% endfor %}
            </div>
            <div class="section-actions">
                <button type="button" class="select-all-btn" onclick="selectAll('featured_products')">Select All</button>
                <button type="button" class="select-all-btn" onclick="deselectAll('featured_products')">Deselect All</button>
            </div>
            {% else %}
            <div class="empty-state">
                <i class="fas fa-box-open"></i>
                <p>No products available</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Flash Sale Products Section -->
    <div class="section-card">
        <div class="section-header" onclick="toggleSection(this)">
            <h3>
                <i class="fas fa-bolt"></i>
                Flash Sale Products
                <span class="count-badge" id="flashSaleBadge">{{ flash_sale_count }}</span>
            </h3>
            <i class="fas fa-chevron-down toggle-icon"></i>
        </div>
        <div class="section-body">
            {% if all_products %}
            <div class="products-grid">
                {% for product in all_products %}
                <label class="product-select-card {% if product.id in selected_flash_sale %}selected{% endif %}" data-name="{{ product.name|lower }}" data-sku="{{ product.sku|lower }}">
                    <div class="checkbox-wrapper">
                        <input type="checkbox" name="flash_sale_products" value="{{ product.id }}"
                               {% if product.id in selected_flash_sale %}checked{% endif %}
                               onchange="updateProductCard(this, 'flash_sale')">
                    </div>
                    <div class="product-image">
                        {% if product.get_main_image %}
                        <img src="{{ product.get_main_image }}" alt="{{ product.name }}">
                        {% else %}
                        <i class="fas fa-image no-image"></i>
                        {% endif %}
                    </div>
                    <div class="product-name" title="{{ product.name }}">{{ product.name }}</div>
                    <div class="product-price">Rs. {{ product.price }}</div>
                    {% if product.vendor %}
                    <div class="product-vendor">{{ product.vendor.business_name }}</div>
                    {% endif %}
                </label>
                {% endfor %}
            </div>
            <div class="section-actions">
                <button type="button" class="select-all-btn" onclick="selectAll('flash_sale_products')">Select All</button>
                <button type="button" class="select-all-btn" onclick="deselectAll('flash_sale_products')">Deselect All</button>
            </div>
            {% else %}
            <div class="empty-state">
                <i class="fas fa-box-open"></i>
                <p>No products available</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- New Arrivals Section -->
    <div class="section-card">
        <div class="section-header" onclick="toggleSection(this)">
            <h3>
                <i class="fas fa-sparkles"></i>
                New Arrivals
                <span class="count-badge" id="newArrivalsBadge">{{ new_arrivals_count }}</span>
            </h3>
            <i class="fas fa-chevron-down toggle-icon"></i>
        </div>
        <div class="section-body">
            {% if all_products %}
            <div class="products-grid">
                {% for product in all_products %}
                <label class="product-select-card {% if product.id in selected_new_arrivals %}selected{% endif %}" data-name="{{ product.name|lower }}" data-sku="{{ product.sku|lower }}">
                    <div class="checkbox-wrapper">
                        <input type="checkbox" name="new_arrival_products" value="{{ product.id }}"
                               {% if product.id in selected_new_arrivals %}checked{% endif %}
                               onchange="updateProductCard(this, 'new_arrivals')">
                    </div>
                    <div class="product-image">
                        {% if product.get_main_image %}
                        <img src="{{ product.get_main_image }}" alt="{{ product.name }}">
                        {% else %}
                        <i class="fas fa-image no-image"></i>
                        {% endif %}
                    </div>
                    <div class="product-name" title="{{ product.name }}">{{ product.name }}</div>
                    <div class="product-price">Rs. {{ product.price }}</div>
                    {% if product.vendor %}
                    <div class="product-vendor">{{ product.vendor.business_name }}</div>
                    {% endif %}
                </label>
                {% endfor %}
            </div>
            <div class="section-actions">
                <button type="button" class="select-all-btn" onclick="selectAll('new_arrival_products')">Select All</button>
                <button type="button" class="select-all-btn" onclick="deselectAll('new_arrival_products')">Deselect All</button>
            </div>
            {% else %}
            <div class="empty-state">
                <i class="fas fa-box-open"></i>
                <p>No products available</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- All Demo Products Section -->
    <div class="section-card">
        <div class="section-header" onclick="toggleSection(this)">
            <h3>
                <i class="fas fa-boxes"></i>
                All Demo Products
                <span class="count-badge" id="allBadge">{{ all_count }}</span>
            </h3>
            <i class="fas fa-chevron-down toggle-icon"></i>
        </div>
        <div class="section-body">
            {% if all_products %}
            <div class="products-grid">
                {% for product in all_products %}
                <label class="product-select-card {% if product.id in selected_all %}selected{% endif %}" data-name="{{ product.name|lower }}" data-sku="{{ product.sku|lower }}">
                    <div class="checkbox-wrapper">
                        <input type="checkbox" name="all_products" value="{{ product.id }}"
                               {% if product.id in selected_all %}checked{% endif %}
                               onchange="updateProductCard(this, 'all')">
                    </div>
                    <div class="product-image">
                        {% if product.get_main_image %}
                        <img src="{{ product.get_main_image }}" alt="{{ product.name }}">
                        {% else %}
                        <i class="fas fa-image no-image"></i>
                        {% endif %}
                    </div>
                    <div class="product-name" title="{{ product.name }}">{{ product.name }}</div>
                    <div class="product-price">Rs. {{ product.price }}</div>
                    {% if product.vendor %}
                    <div class="product-vendor">{{ product.vendor.business_name }}</div>
                    {% endif %}
                </label>
                {% endfor %}
            </div>
            <div class="section-actions">
                <button type="button" class="select-all-btn" onclick="selectAll('all_products')">Select All</button>
                <button type="button" class="select-all-btn" onclick="deselectAll('all_products')">Deselect All</button>
            </div>
            {% else %}
            <div class="empty-state">
                <i class="fas fa-box-open"></i>
                <p>No products available</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Sticky Save Button for Mobile -->
    <div style="position: fixed; bottom: 1rem; right: 1rem; z-index: 100;">
        <button type="submit" class="btn-primary" style="padding: 1rem 2rem; font-size: 1rem; box-shadow: 0 4px 20px rgba(99, 102, 241, 0.4);">
            <i class="fas fa-save"></i> Save Settings
        </button>
    </div>
</form>

<!-- Clear Form (separate to avoid conflict) -->
<form method="post" id="clearForm" style="display: none;">
    {% csrf_token %}
    <input type="hidden" name="action" value="clear_all">
</form>

{% endblock %}

{% block extra_js %}
<script>
    function toggleSection(header) {
        header.classList.toggle('collapsed');
        const body = header.nextElementSibling;
        body.classList.toggle('collapsed');
    }

    function updateProductCard(checkbox, type) {
        const card = checkbox.closest('.product-select-card');
        if (checkbox.checked) {
            card.classList.add('selected');
        } else {
            card.classList.remove('selected');
        }
        updateCounts();
    }

    function updateCategoryCard(checkbox) {
        const card = checkbox.closest('.category-select-card');
        if (checkbox.checked) {
            card.classList.add('selected');
        } else {
            card.classList.remove('selected');
        }
        updateCounts();
    }

    function updateCounts() {
        document.getElementById('featuredCount').textContent = document.querySelectorAll('input[name="featured_products"]:checked').length;
        document.getElementById('featuredBadge').textContent = document.querySelectorAll('input[name="featured_products"]:checked').length;

        document.getElementById('flashSaleCount').textContent = document.querySelectorAll('input[name="flash_sale_products"]:checked').length;
        document.getElementById('flashSaleBadge').textContent = document.querySelectorAll('input[name="flash_sale_products"]:checked').length;

        document.getElementById('newArrivalsCount').textContent = document.querySelectorAll('input[name="new_arrival_products"]:checked').length;
        document.getElementById('newArrivalsBadge').textContent = document.querySelectorAll('input[name="new_arrival_products"]:checked').length;

        document.getElementById('allCount').textContent = document.querySelectorAll('input[name="all_products"]:checked').length;
        document.getElementById('allBadge').textContent = document.querySelectorAll('input[name="all_products"]:checked').length;

        document.getElementById('categoriesBadge').textContent = document.querySelectorAll('input[name="categories"]:checked').length;
    }

    function selectAll(name) {
        document.querySelectorAll(`input[name="${name}"]`).forEach(cb => {
            cb.checked = true;
            const card = cb.closest('.product-select-card');
            if (card) card.classList.add('selected');
        });
        updateCounts();
    }

    function deselectAll(name) {
        document.querySelectorAll(`input[name="${name}"]`).forEach(cb => {
            cb.checked = false;
            const card = cb.closest('.product-select-card');
            if (card) card.classList.remove('selected');
        });
        updateCounts();
    }

    function clearAllSelections() {
        if (confirm('Are you sure you want to clear all demo product selections? Demo pages will show fallback static data.')) {
            document.getElementById('clearForm').submit();
        }
    }

    function filterProducts() {
        const search = document.getElementById('productSearch').value.toLowerCase();
        document.querySelectorAll('.product-select-card').forEach(card => {
            const name = card.dataset.name || '';
            const sku = card.dataset.sku || '';
            if (name.includes(search) || sku.includes(search)) {
                card.style.display = '';
            } else {
                card.style.display = 'none';
            }
        });
    }

    // Live search
    document.getElementById('productSearch').addEventListener('input', filterProducts);
</script>
{% endblock %}
