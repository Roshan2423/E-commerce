{% extends 'vendor/starter/base.html' %}

{% block title %}{% if product %}Edit{% else %}Add{% endif %} Product{% endblock %}
{% block breadcrumb %}{% if product %}Edit Product{% else %}Add Product{% endif %}{% endblock %}

{% block extra_css %}
<style>
    .form-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 1.5rem;
    }

    .form-section {
        background: white;
        border-radius: 12px;
        border: 1px solid var(--border);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .form-section-title {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid var(--border);
    }

    .form-row {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
    }

    .image-upload {
        border: 2px dashed var(--border);
        border-radius: 12px;
        padding: 2rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
        background: #fafafa;
    }

    .image-upload:hover {
        border-color: var(--primary);
        background: #f8f5ff;
    }

    .image-upload i {
        font-size: 2.5rem;
        color: var(--primary);
        margin-bottom: 0.75rem;
    }

    .image-upload p {
        color: var(--text-secondary);
        font-size: 0.875rem;
        margin-bottom: 0.5rem;
    }

    .image-upload small {
        color: #94a3b8;
        font-size: 0.75rem;
    }

    .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
        margin-top: 1.5rem;
        padding-top: 1.5rem;
        border-top: 1px solid var(--border);
    }

    .btn-lg {
        padding: 0.875rem 2rem;
        font-size: 1rem;
    }

    /* Image Preview Section */
    .image-preview-section {
        margin-top: 1.5rem;
    }

    .image-preview-section h4 {
        font-size: 0.875rem;
        color: var(--text-secondary);
        margin-bottom: 0.75rem;
    }

    .image-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 0.75rem;
    }

    .image-item {
        position: relative;
        border-radius: 8px;
        overflow: hidden;
        border: 2px solid var(--border);
        background: #f8fafc;
        transition: all 0.2s;
    }

    .image-item:hover {
        border-color: var(--primary);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .image-item img {
        width: 100%;
        height: 100px;
        object-fit: cover;
        display: block;
    }

    .image-item-actions {
        padding: 0.375rem 0.5rem;
        background: #f1f5f9;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.6875rem;
    }

    .image-item-actions label {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        cursor: pointer;
        font-weight: 500;
    }

    .image-item-actions input[type="radio"] {
        width: 12px;
        height: 12px;
    }

    .delete-image {
        background: none;
        border: none;
        color: #dc2626;
        cursor: pointer;
        padding: 0.125rem;
        font-size: 0.75rem;
        transition: color 0.2s;
    }

    .delete-image:hover {
        color: #b91c1c;
    }

    /* New image indicator */
    .image-item[data-type="new"] {
        border-color: var(--primary);
    }

    .image-item[data-type="new"]::before {
        content: 'NEW';
        position: absolute;
        top: 4px;
        left: 4px;
        background: var(--primary);
        color: white;
        font-size: 0.5rem;
        padding: 0.125rem 0.375rem;
        border-radius: 4px;
        font-weight: 600;
        z-index: 1;
    }

    @media (max-width: 1024px) {
        .form-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">{% if product %}Edit Product{% else %}Add New Product{% endif %}</h1>
    <p class="page-subtitle">{% if product %}Update your product listing{% else %}Create a new product listing for your store{% endif %}</p>
</div>

<form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    <div class="form-grid">
        <!-- Main Form -->
        <div class="form-main">
            <!-- Basic Info -->
            <div class="form-section">
                <h3 class="form-section-title">Basic Information</h3>

                <div class="form-group">
                    <label class="form-label">Product Name *</label>
                    <input type="text" name="name" class="form-control" placeholder="Enter product name" value="{{ product.name|default:'' }}" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Short Description</label>
                    <textarea name="short_description" class="form-control" rows="2" placeholder="Brief description for product cards">{{ product.short_description|default:'' }}</textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Full Description</label>
                    <textarea name="description" class="form-control" rows="5" placeholder="Detailed product description">{{ product.description|default:'' }}</textarea>
                </div>
            </div>

            <!-- Pricing -->
            <div class="form-section">
                <h3 class="form-section-title">Pricing</h3>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Regular Price (Rs.) *</label>
                        <input type="number" name="price" class="form-control" placeholder="0.00" step="0.01" min="0" value="{{ product.price|default:'' }}" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Compare at Price (Rs.)</label>
                        <input type="number" name="compare_price" class="form-control" placeholder="0.00" step="0.01" min="0" value="{{ product.compare_price|default:'' }}">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Cost per Item (Rs.)</label>
                    <input type="number" name="cost_price" class="form-control" placeholder="0.00" step="0.01" min="0" value="{{ product.cost_price|default:'' }}">
                    <small style="color: var(--text-secondary); font-size: 0.75rem;">Customers won't see this</small>
                </div>
            </div>

            <!-- Inventory -->
            <div class="form-section">
                <h3 class="form-section-title">Inventory</h3>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">SKU (Stock Keeping Unit)</label>
                        <input type="text" name="sku" class="form-control" placeholder="Auto-generated if empty" value="{{ product.sku|default:'' }}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Stock Quantity *</label>
                        <input type="number" name="stock_quantity" class="form-control" placeholder="0" min="0" value="{{ product.stock_quantity|default:0 }}" required>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Low Stock Threshold</label>
                    <input type="number" name="low_stock_threshold" class="form-control" placeholder="10" min="0" value="{{ product.low_stock_threshold|default:10 }}">
                    <small style="color: var(--text-secondary); font-size: 0.75rem;">Alert when stock falls below this</small>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="form-sidebar">
            <!-- Status -->
            <div class="form-section">
                <h3 class="form-section-title">Status</h3>

                <div class="form-group">
                    <label class="form-label">Product Status</label>
                    <select name="is_active" class="form-control">
                        <option value="1" {% if product.is_active or not product %}selected{% endif %}>Active</option>
                        <option value="0" {% if product and not product.is_active %}selected{% endif %}>Draft</option>
                    </select>
                </div>

                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" name="is_featured" {% if product.is_featured %}checked{% endif %}>
                        <span class="form-label" style="margin: 0;">Featured Product</span>
                    </label>
                </div>
            </div>

            <!-- Category -->
            <div class="form-section">
                <h3 class="form-section-title">Organization</h3>

                <div class="form-group">
                    <label class="form-label">Category *</label>
                    <select name="category" class="form-control" required>
                        <option value="">Select category</option>
                        {% for category in categories %}
                        <option value="{{ category.id }}" {% if product.category_id == category.id %}selected{% endif %}>{{ category.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- Images -->
            <div class="form-section">
                <h3 class="form-section-title">Product Images</h3>

                <div class="image-upload" onclick="document.getElementById('images').click()">
                    <input type="file" id="images" name="images" multiple accept="image/*" hidden onchange="handleImageUpload(this)">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <p>Click to upload images</p>
                    <small>PNG, JPG up to 5MB</small>
                </div>

                <!-- Unified Image Grid -->
                <div id="imageGridContainer" class="image-preview-section" {% if not product or not product.images.all %}style="display: none;"{% endif %}>
                    <div class="image-grid" id="unifiedImageGrid">
                        {% if product and product.images.all %}
                        {% for image in product.images.all %}
                        <div class="image-item" data-type="existing" data-id="{{ image.id }}">
                            <img src="{{ image.image.url }}" alt="{{ image.alt_text }}">
                            <div class="image-item-actions">
                                <label>
                                    <input type="radio" name="main_image" value="existing_{{ image.id }}" {% if image.is_main %}checked{% endif %}>
                                    Main
                                </label>
                                <button type="button" class="delete-image" onclick="deleteImage(this, {{ image.id }})" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Form Actions -->
    <div class="form-section">
        <div class="form-actions">
            <a href="{% url 'vendor:products' %}" class="btn btn-outline btn-lg">
                Cancel
            </a>
            <button type="submit" class="btn btn-primary btn-lg">
                <i class="fas fa-save"></i>
                {% if product %}Update Product{% else %}Save Product{% endif %}
            </button>
        </div>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
    // Store selected files
    let newImages = [];

    function handleImageUpload(input) {
        const container = document.getElementById('imageGridContainer');
        const grid = document.getElementById('unifiedImageGrid');

        if (input.files && input.files.length > 0) {
            container.style.display = 'block';

            Array.from(input.files).forEach((file) => {
                newImages.push(file);
                const currentIndex = newImages.length - 1;

                const reader = new FileReader();
                reader.onload = function(e) {
                    const div = document.createElement('div');
                    div.className = 'image-item';
                    div.dataset.type = 'new';
                    div.dataset.index = currentIndex;

                    // Check if this should be main (no other main selected)
                    const hasMain = grid.querySelector('input[name="main_image"]:checked');
                    const isMain = !hasMain;

                    div.innerHTML = `
                        <img src="${e.target.result}" alt="Preview">
                        <div class="image-item-actions">
                            <label>
                                <input type="radio" name="main_image" value="new_${currentIndex}" ${isMain ? 'checked' : ''}>
                                Main
                            </label>
                            <button type="button" class="delete-image" onclick="removeNewImage(this, ${currentIndex})" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    grid.appendChild(div);
                };
                reader.readAsDataURL(file);
            });

            // Update the file input with all new images
            updateFileInput();
        }
    }

    function updateFileInput() {
        const dt = new DataTransfer();
        newImages.forEach((file, index) => {
            if (file) dt.items.add(file);
        });
        document.getElementById('images').files = dt.files;

        // Update radio values to match actual file positions
        updateRadioValues();
    }

    function updateRadioValues() {
        const grid = document.getElementById('unifiedImageGrid');
        const newItems = grid.querySelectorAll('.image-item[data-type="new"]');
        let actualIndex = 0;

        newItems.forEach((item) => {
            const dataIndex = parseInt(item.dataset.index);
            if (newImages[dataIndex]) {
                const radio = item.querySelector('input[type="radio"]');
                radio.value = 'new_' + actualIndex;
                actualIndex++;
            }
        });
    }

    function removeNewImage(btn, index) {
        const item = btn.closest('.image-item');
        const wasMain = item.querySelector('input[name="main_image"]').checked;

        // Mark as null (to preserve indices for other items during this session)
        newImages[index] = null;

        // Remove from DOM
        item.remove();

        // Update file input and radio values
        updateFileInput();

        // If was main, select first available
        if (wasMain) {
            selectFirstAsMain();
        }

        // Hide container if empty
        checkGridVisibility();
    }

    function deleteImage(btn, imageId) {
        if (confirm('Are you sure you want to delete this image?')) {
            const item = btn.closest('.image-item');
            const wasMain = item.querySelector('input[name="main_image"]').checked;

            fetch(`/vendor/product/image/${imageId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    item.remove();
                    if (wasMain) selectFirstAsMain();
                    checkGridVisibility();
                } else {
                    alert('Failed to delete image');
                }
            })
            .catch(error => {
                // Fallback: just remove the element
                item.remove();
                if (wasMain) selectFirstAsMain();
                checkGridVisibility();
            });
        }
    }

    function selectFirstAsMain() {
        const grid = document.getElementById('unifiedImageGrid');
        const firstRadio = grid.querySelector('input[name="main_image"]');
        if (firstRadio) {
            firstRadio.checked = true;
        }
    }

    function checkGridVisibility() {
        const container = document.getElementById('imageGridContainer');
        const grid = document.getElementById('unifiedImageGrid');
        if (grid.children.length === 0) {
            container.style.display = 'none';
        }
    }
</script>
{% endblock %}
