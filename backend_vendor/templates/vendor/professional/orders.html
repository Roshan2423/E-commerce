{% extends 'vendor/professional/base.html' %}
{% load static %}

{% block title %}Orders - {{ business.business_name }}{% endblock %}

{% block breadcrumb %}
<a href="{% url 'vendor:dashboard' %}" class="cf-breadcrumb-item">
    <i class="fas fa-home"></i>
</a>
<span class="cf-breadcrumb-separator">/</span>
<span class="cf-breadcrumb-item active">Orders</span>
{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1 class="page-title">Orders</h1>
        <p class="page-subtitle">Manage and track customer orders</p>
    </div>
    <div>
        <a href="{% url 'vendor:orders' %}?export=csv" class="btn btn-outline">
            <i class="fas fa-download"></i> Export
        </a>
    </div>
</div>

<!-- Order Status Stats -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon primary"><i class="fas fa-shopping-bag"></i></div>
        <div class="stat-content">
            <div class="stat-value">{{ total_orders|default:"0" }}</div>
            <div class="stat-label">Total</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon warning"><i class="fas fa-clock"></i></div>
        <div class="stat-content">
            <div class="stat-value">{{ pending_count|default:"0" }}</div>
            <div class="stat-label">Pending</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon info"><i class="fas fa-sync"></i></div>
        <div class="stat-content">
            <div class="stat-value">{{ processing_count|default:"0" }}</div>
            <div class="stat-label">Processing</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon info"><i class="fas fa-truck"></i></div>
        <div class="stat-content">
            <div class="stat-value">{{ shipped_count|default:"0" }}</div>
            <div class="stat-label">Shipped</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon success"><i class="fas fa-check-circle"></i></div>
        <div class="stat-content">
            <div class="stat-value">{{ delivered_count|default:"0" }}</div>
            <div class="stat-label">Delivered</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon danger"><i class="fas fa-times-circle"></i></div>
        <div class="stat-content">
            <div class="stat-value">{{ cancelled_count|default:"0" }}</div>
            <div class="stat-label">Cancelled</div>
        </div>
    </div>
</div>

<!-- Orders Table -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">All Orders</h3>
        <div class="filter-bar">
            <input type="text" class="form-control" id="searchInput" placeholder="Search orders..." value="{{ request.GET.q }}">
            <select class="form-control" id="statusFilter">
                <option value="">All Status</option>
                <option value="pending" {% if request.GET.status == 'pending' %}selected{% endif %}>Pending</option>
                <option value="processing" {% if request.GET.status == 'processing' %}selected{% endif %}>Processing</option>
                <option value="shipped" {% if request.GET.status == 'shipped' %}selected{% endif %}>Shipped</option>
                <option value="delivered" {% if request.GET.status == 'delivered' %}selected{% endif %}>Delivered</option>
                <option value="cancelled" {% if request.GET.status == 'cancelled' %}selected{% endif %}>Cancelled</option>
            </select>
            <select class="form-control" id="paymentFilter">
                <option value="">All Payment</option>
                <option value="paid" {% if request.GET.payment == 'paid' %}selected{% endif %}>Paid</option>
                <option value="unpaid" {% if request.GET.payment == 'unpaid' %}selected{% endif %}>Unpaid</option>
            </select>
        </div>
    </div>
    <div class="card-body" style="padding: 0;">
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>Order ID</th>
                        <th>Customer</th>
                        <th>Product</th>
                        <th>Amount</th>
                        <th>Payment</th>
                        <th>Status</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in order_items %}
                    <tr>
                        <td><span class="order-id">#{{ item.order.get_order_number }}</span></td>
                        <td>
                            <div class="customer-info">
                                <span class="customer-name">{{ item.order.user.get_full_name|default:item.order.guest_email|default:"Guest User" }}</span>
                                <span class="customer-email">{{ item.order.user.email|default:item.order.guest_email|default:"N/A" }}</span>
                            </div>
                        </td>
                        <td>
                            <div class="product-info">
                                <span class="product-name">{{ item.product_name }}</span>
                                <span class="product-qty">x{{ item.quantity }}</span>
                            </div>
                        </td>
                        <td><strong>Rs. {{ item.total_price|floatformat:0 }}</strong></td>
                        <td>
                            {% if item.order.payment_status == 'paid' %}
                            <span class="badge badge-success">Paid</span>
                            {% else %}
                            <span class="badge badge-warning">Unpaid</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if item.order.status == 'delivered' %}
                            <span class="badge badge-success">Delivered</span>
                            {% elif item.order.status == 'shipped' %}
                            <span class="badge badge-info">Shipped</span>
                            {% elif item.order.status == 'processing' %}
                            <span class="badge badge-info">Processing</span>
                            {% elif item.order.status == 'pending' %}
                            <span class="badge badge-warning">Pending</span>
                            {% elif item.order.status == 'cancelled' %}
                            <span class="badge badge-danger">Cancelled</span>
                            {% else %}
                            <span class="badge badge-secondary">{{ item.order.status|title }}</span>
                            {% endif %}
                        </td>
                        <td>{{ item.order.created_at|date:"M d, Y H:i" }}</td>
                        <td>
                            <div class="action-buttons">
                                <a href="{% url 'vendor:order_detail' item.order.order_id %}" class="btn btn-sm btn-outline" title="View">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <a href="{% url 'vendor:order_detail' item.order.order_id %}?print=1" class="btn btn-sm btn-outline" title="Print" target="_blank">
                                    <i class="fas fa-print"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8">
                            <div class="empty-state">
                                <i class="fas fa-shopping-bag"></i>
                                <p>No orders found</p>
                                <span>Orders for your products will appear here</span>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Pagination -->
{% if order_items.has_other_pages %}
<div class="pagination">
    {% if order_items.has_previous %}
    <a href="?page={{ order_items.previous_page_number }}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.payment %}&payment={{ request.GET.payment }}{% endif %}" class="page-btn">
        <i class="fas fa-chevron-left"></i>
    </a>
    {% endif %}

    {% for num in order_items.paginator.page_range %}
        {% if order_items.number == num %}
        <span class="page-btn active">{{ num }}</span>
        {% elif num > order_items.number|add:'-3' and num < order_items.number|add:'3' %}
        <a href="?page={{ num }}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.payment %}&payment={{ request.GET.payment }}{% endif %}" class="page-btn">{{ num }}</a>
        {% endif %}
    {% endfor %}

    {% if order_items.has_next %}
    <a href="?page={{ order_items.next_page_number }}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.payment %}&payment={{ request.GET.payment }}{% endif %}" class="page-btn">
        <i class="fas fa-chevron-right"></i>
    </a>
    {% endif %}
</div>
{% endif %}
{% endblock %}

{% block extra_css %}
<style>
.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
}

.page-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--text-primary, #1f2937);
    margin: 0;
}

.page-subtitle {
    font-size: 0.875rem;
    color: var(--text-secondary, #6b7280);
    margin: 0.25rem 0 0;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.stat-card {
    background: var(--bg-primary, #fff);
    border-radius: var(--radius, 8px);
    padding: 1rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.stat-icon {
    width: 48px;
    height: 48px;
    border-radius: var(--radius, 8px);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
}

.stat-icon.primary { background: #dbeafe; color: #2563eb; }
.stat-icon.warning { background: #fef3c7; color: #d97706; }
.stat-icon.info { background: #e0e7ff; color: #4f46e5; }
.stat-icon.success { background: #d1fae5; color: #059669; }
.stat-icon.danger { background: #fee2e2; color: #dc2626; }

.stat-content {
    flex: 1;
}

.stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text-primary, #1f2937);
}

.stat-label {
    font-size: 0.75rem;
    color: var(--text-secondary, #6b7280);
    text-transform: uppercase;
}

.card {
    background: var(--bg-primary, #fff);
    border-radius: var(--radius, 8px);
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--border, #e5e7eb);
    flex-wrap: wrap;
    gap: 1rem;
}

.card-title {
    font-size: 1rem;
    font-weight: 600;
    margin: 0;
}

.card-body {
    padding: 1.5rem;
}

.filter-bar {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
}

.filter-bar .form-control {
    width: auto;
    min-width: 140px;
    padding: 0.5rem 0.75rem;
    border: 1px solid var(--border, #e5e7eb);
    border-radius: var(--radius, 6px);
    font-size: 0.875rem;
}

.table-responsive {
    overflow-x: auto;
}

.table {
    width: 100%;
    border-collapse: collapse;
}

.table th,
.table td {
    padding: 0.875rem 1rem;
    text-align: left;
    border-bottom: 1px solid var(--border, #e5e7eb);
}

.table th {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--text-secondary, #6b7280);
    text-transform: uppercase;
    background: var(--bg-secondary, #f9fafb);
}

.order-id {
    font-family: var(--font-mono, monospace);
    color: var(--primary, #2563eb);
    font-weight: 500;
}

.customer-info,
.product-info {
    display: flex;
    flex-direction: column;
}

.customer-name,
.product-name {
    font-weight: 500;
}

.customer-email,
.product-qty {
    font-size: 0.75rem;
    color: var(--text-secondary, #6b7280);
}

.badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 500;
}

.badge-success { background: #d1fae5; color: #065f46; }
.badge-warning { background: #fef3c7; color: #92400e; }
.badge-info { background: #dbeafe; color: #1e40af; }
.badge-danger { background: #fee2e2; color: #991b1b; }
.badge-secondary { background: #f3f4f6; color: #4b5563; }

.action-buttons {
    display: flex;
    gap: 0.5rem;
}

.btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border-radius: var(--radius, 6px);
    font-size: 0.875rem;
    font-weight: 500;
    text-decoration: none;
    cursor: pointer;
    border: none;
    transition: all 0.2s;
}

.btn-outline {
    background: transparent;
    border: 1px solid var(--border, #e5e7eb);
    color: var(--text-primary, #1f2937);
}

.btn-outline:hover {
    background: var(--bg-secondary, #f9fafb);
    border-color: var(--primary, #2563eb);
    color: var(--primary, #2563eb);
}

.btn-sm {
    padding: 0.375rem 0.625rem;
    font-size: 0.8125rem;
}

.empty-state {
    text-align: center;
    padding: 3rem;
    color: var(--text-secondary, #6b7280);
}

.empty-state i {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}

.empty-state p {
    font-weight: 500;
    margin-bottom: 0.5rem;
}

.empty-state span {
    font-size: 0.875rem;
}

.pagination {
    display: flex;
    justify-content: center;
    gap: 0.5rem;
    margin-top: 1.5rem;
}

.page-btn {
    padding: 0.5rem 0.875rem;
    border: 1px solid var(--border, #e5e7eb);
    border-radius: var(--radius, 6px);
    background: var(--bg-primary, #fff);
    color: var(--text-primary, #1f2937);
    text-decoration: none;
    font-size: 0.875rem;
}

.page-btn.active {
    background: var(--primary, #2563eb);
    color: white;
    border-color: var(--primary, #2563eb);
}

.page-btn:hover:not(.active) {
    background: var(--bg-secondary, #f9fafb);
}

@media (max-width: 1200px) {
    .stats-grid {
        grid-template-columns: repeat(3, 1fr);
    }
}

@media (max-width: 768px) {
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }

    .filter-bar {
        width: 100%;
    }

    .filter-bar .form-control {
        flex: 1;
        min-width: 100px;
    }

    .page-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
    // Status filter
    document.getElementById('statusFilter').addEventListener('change', function() {
        const params = new URLSearchParams(window.location.search);
        if (this.value) {
            params.set('status', this.value);
        } else {
            params.delete('status');
        }
        params.delete('page');
        window.location.href = '?' + params.toString();
    });

    // Payment filter
    document.getElementById('paymentFilter').addEventListener('change', function() {
        const params = new URLSearchParams(window.location.search);
        if (this.value) {
            params.set('payment', this.value);
        } else {
            params.delete('payment');
        }
        params.delete('page');
        window.location.href = '?' + params.toString();
    });

    // Search functionality
    let searchTimeout;
    document.getElementById('searchInput').addEventListener('input', function() {
        clearTimeout(searchTimeout);
        const query = this.value;
        searchTimeout = setTimeout(function() {
            const params = new URLSearchParams(window.location.search);
            if (query) {
                params.set('q', query);
            } else {
                params.delete('q');
            }
            params.delete('page');
            window.location.href = '?' + params.toString();
        }, 500);
    });
</script>
{% endblock %}
