{% extends 'admin/base.html' %}
{% load static %}

{% block title %}Categories - E-Commerce Admin{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">
        <i class="fas fa-tags"></i>
        Category Management
    </h1>
    <p class="page-subtitle">Organize your products with categories</p>
</div>

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
    <div></div>
    <a href="/products/categories/add/" class="btn btn-primary">
        <i class="fas fa-plus"></i>
        Add New Category
    </a>
</div>

<!-- Categories Grid -->
<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 24px;">
    {% for category in categories %}
    <div class="data-table">
        <div class="table-header">
            <h3 class="table-title">{{ category.name }}</h3>
            <div style="display: flex; gap: 8px;">
                {% if category.is_active %}
                    <span class="badge success">Active</span>
                {% else %}
                    <span class="badge danger">Inactive</span>
                {% endif %}
            </div>
        </div>
        <div style="padding: 24px;">
            {% if category.description %}
            <p style="color: #64748b; margin: 0 0 20px 0;">{{ category.description|truncatechars:100 }}</p>
            {% endif %}
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <span style="color: #64748b;">Products:</span>
                <span class="badge primary">{{ category.products.count|default:0 }}</span>
            </div>
            
            <div style="display: flex; gap: 8px;">
                <a href="/products/?category={{ category.id }}" class="btn btn-outline" style="flex: 1; justify-content: center; font-size: 12px; padding: 8px;">
                    <i class="fas fa-eye"></i>
                    View Products
                </a>
                <a href="{% url 'products:category_edit' category.pk %}" class="btn btn-warning" style="padding: 8px 12px;" title="Edit Category">
                    <i class="fas fa-edit"></i>
                </a>
                <a href="{% url 'products:category_delete' category.pk %}" class="btn btn-danger delete-category-btn" style="padding: 8px 12px;" title="Delete Category" 
                   data-category-id="{{ category.pk }}" data-category-name="{{ category.name }}" data-product-count="{{ category.products.count }}">
                    <i class="fas fa-trash"></i>
                </a>
            </div>
        </div>
    </div>
    {% empty %}
    <!-- Empty State -->
    <div style="grid-column: 1 / -1;">
        <div class="data-table">
            <div style="padding: 60px; text-align: center;">
                <i class="fas fa-tags fa-3x" style="color: #cbd5e1; margin-bottom: 20px;"></i>
                <h3 style="color: #64748b; margin: 0 0 8px 0;">No categories yet</h3>
                <p style="color: #64748b; margin: 0 0 24px 0;">Create your first category to organize your products</p>
                <a href="/products/categories/add/" class="btn btn-primary">
                    <i class="fas fa-plus"></i>
                    Create First Category
                </a>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Sample Categories if none exist -->
{% if not categories %}
<div style="margin-top: 32px;">
    <div class="data-table">
        <div class="table-header">
            <h3 class="table-title">
                <i class="fas fa-lightbulb"></i>
                Suggested Categories
            </h3>
        </div>
        <div style="padding: 24px;">
            <p style="color: #64748b; margin: 0 0 20px 0;">
                Here are some popular category ideas to get you started:
            </p>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                <div style="background: #f8fafc; padding: 16px; border-radius: 12px; text-align: center;">
                    <i class="fas fa-laptop fa-2x" style="color: #3b82f6; margin-bottom: 8px;"></i>
                    <h5 style="margin: 0;">Electronics</h5>
                </div>
                <div style="background: #f8fafc; padding: 16px; border-radius: 12px; text-align: center;">
                    <i class="fas fa-tshirt fa-2x" style="color: #10b981; margin-bottom: 8px;"></i>
                    <h5 style="margin: 0;">Clothing</h5>
                </div>
                <div style="background: #f8fafc; padding: 16px; border-radius: 12px; text-align: center;">
                    <i class="fas fa-book fa-2x" style="color: #f59e0b; margin-bottom: 8px;"></i>
                    <h5 style="margin: 0;">Books</h5>
                </div>
                <div style="background: #f8fafc; padding: 16px; border-radius: 12px; text-align: center;">
                    <i class="fas fa-home fa-2x" style="color: #ef4444; margin-bottom: 8px;"></i>
                    <h5 style="margin: 0;">Home & Garden</h5>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle instant category deletion
    document.querySelectorAll('.delete-category-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault(); // Prevent default link behavior
            
            const categoryId = this.dataset.categoryId;
            const categoryName = this.dataset.categoryName;
            const productCount = parseInt(this.dataset.productCount);
            const deleteUrl = this.href;
            
            // Check if category has products
            if (productCount > 0) {
                // Show error message instantly
                showToast(`Cannot delete "${categoryName}" - it has ${productCount} product${productCount > 1 ? 's' : ''}`, 'error');
                return;
            }
            
            // Find the category card element
            const categoryCard = this.closest('.data-table');
            
            // Show instant feedback - fade out the category
            categoryCard.style.opacity = '0.5';
            categoryCard.style.pointerEvents = 'none';
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            this.style.pointerEvents = 'none';
            
            // Make the actual deletion request
            fetch(deleteUrl, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                }
            })
            .then(response => {
                if (response.ok) {
                    // Success - animate removal
                    categoryCard.style.transition = 'all 0.3s ease';
                    categoryCard.style.transform = 'scale(0.8)';
                    categoryCard.style.opacity = '0';
                    
                    setTimeout(() => {
                        categoryCard.remove();
                        showToast(`Category "${categoryName}" deleted successfully!`, 'success');
                        
                        // Check if no categories left
                        const remainingCategories = document.querySelectorAll('.data-table').length;
                        if (remainingCategories === 0) {
                            location.reload(); // Reload to show empty state
                        }
                    }, 300);
                } else {
                    // Error - restore button
                    categoryCard.style.opacity = '1';
                    categoryCard.style.pointerEvents = 'auto';
                    this.innerHTML = '<i class="fas fa-trash"></i>';
                    this.style.pointerEvents = 'auto';
                    showToast('Error deleting category. Please try again.', 'error');
                }
            })
            .catch(error => {
                // Network error - restore button
                categoryCard.style.opacity = '1';
                categoryCard.style.pointerEvents = 'auto';
                this.innerHTML = '<i class="fas fa-trash"></i>';
                this.style.pointerEvents = 'auto';
                showToast('Network error. Please check your connection.', 'error');
            });
        });
    });
    
    // Toast notification system
    function showToast(message, type = 'info') {
        // Remove existing toast
        const existingToast = document.querySelector('.toast-notification');
        if (existingToast) {
            existingToast.remove();
        }
        
        // Create toast
        const toast = document.createElement('div');
        toast.className = `toast-notification toast-${type}`;
        toast.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            max-width: 400px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        `;
        
        // Set colors based on type
        if (type === 'success') {
            toast.style.background = 'linear-gradient(135deg, #10b981, #059669)';
        } else if (type === 'error') {
            toast.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
        } else {
            toast.style.background = 'linear-gradient(135deg, #3b82f6, #2563eb)';
        }
        
        toast.innerHTML = `
            <div style="display: flex; align-items: center; gap: 8px;">
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                <span>${message}</span>
            </div>
        `;
        
        document.body.appendChild(toast);
        
        // Animate in
        setTimeout(() => {
            toast.style.transform = 'translateX(0)';
        }, 100);
        
        // Auto-remove after 3 seconds
        setTimeout(() => {
            toast.style.transform = 'translateX(100%)';
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 300);
        }, 3000);
    }
});
</script>

{% endblock %}